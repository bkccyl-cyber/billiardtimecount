<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­è³½äº‹è¨ˆåˆ†æ¿ - V5.2 Final (Match Point)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { 
            --bg: #0a0e14;
            --blue: #326eff;
            --red: #e32d2d;
            --green: #00ff00;
            --purple: #af52de;
            --yellow: #ffeb3b;
            --btn-dark: #1a1a1a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; -webkit-user-select: none; }
        
        body { 
            background-color: var(--bg);
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        .hidden-header {
            position: absolute; top: 10px; left: 10px; z-index: 200; opacity: 0.3; transition: opacity 0.3s;
        }
        .hidden-header:hover { opacity: 1; }
        .setting-btn {
            background: #222; border: 1px solid #444; color: #888;
            padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
        }

        .main-stage { 
            flex: 1; display: flex; position: relative; 
            align-items: center; justify-content: center; width: 100%;
        }

        /* --- è¨ˆæ™‚å™¨å€åŸŸ (å‹•æ…‹ä½ç½®) --- */
        .center-timer-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50; 
            text-align: center;
            pointer-events: none; 
            display: none; 
            padding: 20px 40px;
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* æš«åœæ¨¡å¼ï¼šç´…æ¡† + ç§»è‡³åº•éƒ¨ + ç¸®å° 85% */
        .center-timer-overlay.timeout-mode {
            top: auto !important;       
            bottom: 15vh;              
            transform: translate(-50%, 0) scale(0.85); 
            
            border: 4px solid var(--red);
            background-color: rgba(0, 0, 0, 0.95);
            box-shadow: 0 0 30px rgba(227, 45, 45, 0.3);
        }

        .big-timer-val {
            font-size: 25vh; font-weight: 900; line-height: 1;
            font-variant-numeric: tabular-nums;
            transition: color 0.2s;
            text-shadow: 3px 3px 0px #1a1a1a;
        }

        .timer-green { color: var(--green); } 
        .timer-red-text { color: var(--red); }

        /* å‘¼å¸ç‡ˆ (å·²æ”¶æ–‚å…‰æšˆ) */
        @keyframes neon-pulse {
            0%, 100% { text-shadow: 0 0 5px var(--red), 0 0 15px var(--red); opacity: 1; }
            50% { text-shadow: 0 0 2px #990000, 0 0 8px #990000; opacity: 0.7; }
        }
        .timer-red-neon { color: var(--red); animation: neon-pulse 1s ease-in-out infinite; }

        .timer-label-top {
            font-size: 2rem; color: #666; margin-bottom: -10px;
            text-transform: uppercase; letter-spacing: 2px;
        }

        /* --- çƒå“¡èˆ‡æ¨™è¨˜ --- */
        .player-col { 
            flex: 1; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative; 
        }

        .player-name {
            font-size: 2.5rem; font-weight: 700; margin-bottom: 2vh; 
            text-transform: uppercase; letter-spacing: 1px; margin-top: -10vh; 
        }
        .name-blue { color: var(--blue); }
        .name-red { color: var(--red); }

        .score-val { 
            font-size: 45vh; font-weight: 900; line-height: 1; color: #ffffff;
            font-variant-numeric: tabular-nums; text-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: color 0.3s, text-shadow 0.3s; /* é¡è‰²è½‰æ›éæ¸¡ */
        }

        /* --- è½ç‰Œæ¨£å¼ (Match Point) --- */
        .score-match-point {
            color: var(--yellow) !important;
            /* è¼•å¾®éœ“è™¹ç‡ˆæ¨£å¼ */
            text-shadow: 0 0 15px rgba(255, 235, 59, 0.6), 0 0 30px rgba(255, 235, 59, 0.3) !important;
        }

        .indicator-tag {
            position: absolute; padding: 8px 16px; border-radius: 6px;
            font-weight: 900; font-size: 1.8rem; display: none; z-index: 60;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .tag-ext { top: 25%; background-color: var(--yellow); color: #000; border: 2px solid #eab308; }
        .tag-to { top: 55%; background-color: var(--purple); color: #fff; border: 2px solid #9333ea; }
        .pos-left { left: 30px; }
        .pos-right { right: 30px; }

        /* --- åº•éƒ¨æ§åˆ¶å€ --- */
        .controls-bar { 
            height: 14vh; padding: 0 15px 15px 15px; display: flex; gap: 12px; 
            z-index: 100; width: 100%; border-top: 1px solid #222; position: relative;
        }
        .btn-base {
            border: none; border-radius: 16px; color: white; font-size: 2.5rem; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; height: 100%; transition: transform 0.1s;
        }
        .btn-base:active { transform: scale(0.96); }
        .btn-minus { flex: 1; background-color: var(--btn-dark); color: #64748b; border: 1px solid #333; }
        .btn-plus { flex: 3; }
        .plus-blue { background-color: var(--blue); }
        .plus-red { background-color: var(--red); }
        
        .center-box {
            flex: 2; background: rgba(17, 17, 17, 0.9); border: 2px solid #333; 
            border-radius: 16px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        .center-label { color: #888; font-size: 0.9rem; margin-bottom: 2px; }
        .center-value { font-size: 3rem; font-weight: 900; color: var(--yellow); line-height: 1; }

        /* --- è£åˆ¤ç«¯æŒ‰éˆ•æ¨£å¼ --- */
        #referee-panel { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; padding: 15px; z-index: 2000; overflow-y: auto;
        }
        .ref-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; padding-bottom: 40px; }
        .ref-btn { 
            background: #1a1a1a; border: 1px solid #333; color: #e2e8f0; 
            border-radius: 12px; font-size: 1.3rem; font-weight: bold; cursor: pointer; padding: 15px;
            transition: all 0.2s;
        }
        .ref-btn:active { background: #333; }
        
        /* é–å®šæŒ‰éˆ•æ¨£å¼ */
        .ref-btn:disabled {
            background-color: #2a2a2a !important;
            color: #555 !important;
            border-color: #333 !important;
            cursor: not-allowed;
            opacity: 0.6;
            filter: grayscale(1);
        }

        .btn-accent { background: #0e3a0e; border-color: var(--green); color: white; }
        .btn-warn { border-color: var(--yellow); color: var(--yellow); }

        #winner-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .winner-cup { font-size: 15rem; margin-bottom: 20px; filter: drop-shadow(0 0 30px gold); animation: bounce 2s infinite; }
        .winner-text { font-size: 4rem; font-weight: 900; color: white; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        
        #config-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 4000; padding: 30px; }
        .config-item { margin-bottom: 20px; }
        .config-item label { display: block; color: #888; margin-bottom: 8px; }
        .config-item input { background: #222; border: 1px solid #444; color: white; width: 100%; padding: 15px; font-size: 1.5rem; border-radius: 8px; text-align: center; }
        #qr-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div id="player-panel" style="height: 100%; display: flex; flex-direction: column;">
        <div class="hidden-header">
            <button class="setting-btn" onclick="showQRCode()">é€£æ¥è£åˆ¤ | ID: <span id="display-my-id">...</span></button>
        </div>

        <div class="main-stage">
            <div id="big-timer-layer" class="center-timer-overlay">
                <div id="big-timer-label" class="timer-label-top">æ“Šçƒè¨ˆæ™‚</div>
                <div id="big-timer-val" class="big-timer-val timer-green">30</div>
            </div>

            <div class="player-col">
                <div class="player-name name-blue">PLAYER A</div>
                <div id="tag-ext-a" class="indicator-tag tag-ext pos-left">EXT</div>
                <div id="tag-to-a" class="indicator-tag tag-to pos-left">T.O.</div>
                <div class="score-val" id="scoreA">0</div>
            </div>

            <div class="player-col">
                <div class="player-name name-red">PLAYER B</div>
                <div id="tag-ext-b" class="indicator-tag tag-ext pos-right">EXT</div>
                <div id="tag-to-b" class="indicator-tag tag-to pos-right">T.O.</div>
                <div class="score-val" id="scoreB">0</div>
            </div>
        </div>
        
        <div class="controls-bar">
            <button class="btn-base btn-minus" onclick="handleInput('scoreA-')">-</button>
            <button class="btn-base btn-plus plus-blue" onclick="handleInput('scoreA+')">+</button>
            <div class="center-box"><div class="center-label">ç›®æ¨™å±€æ•¸</div><div class="center-value" id="race-display">5</div></div>
            <button class="btn-base btn-plus plus-red" onclick="handleInput('scoreB+')">+</button>
            <button class="btn-base btn-minus" onclick="handleInput('scoreB-')">-</button>
        </div>
    </div>

    <div id="winner-overlay" onclick="handleInput('resetAll')">
        <div class="winner-cup">ğŸ†</div><div class="winner-text" id="winner-name">PLAYER A WINS</div>
        <div style="color:#64748b; margin-top:20px;">é»æ“Šè¢å¹•é‡ç½®æ¯”è³½</div>
    </div>
    
    <div id="referee-panel">
        <div style="text-align: center; color: var(--green); margin-bottom: 10px; font-weight:bold;">REFEREE CONTROL</div>
        <div class="ref-grid">
            <button class="ref-btn btn-accent" style="grid-column: span 2; height: 80px;" onclick="handleInput('start_shot')">é–‹å§‹æ“Šçƒ (Start)</button>
            <button class="ref-btn" onclick="handleInput('start_open')">è¡çƒè¨ˆæ™‚</button>
            <button class="ref-btn btn-warn" onclick="handleInput('pause')">æš«åœ / ç¹¼çºŒ</button>
            
            <button id="ref-extA" class="ref-btn" onclick="handleInput('extA')">A å»¶é•·</button>
            <button id="ref-extB" class="ref-btn" onclick="handleInput('extB')">B å»¶é•·</button>
            <button id="ref-toA" class="ref-btn" style="border-color:var(--purple); color:var(--purple);" onclick="handleInput('toA')">A æš«åœ</button>
            <button id="ref-toB" class="ref-btn" style="border-color:var(--purple); color:var(--purple);" onclick="handleInput('toB')">B æš«åœ</button>
            
            <button class="ref-btn" style="background:#222" onclick="openConfig()">è³½åˆ¶è¨­å®š</button>
            <button class="ref-btn" style="background:#222" onclick="showQRCode()">é…å°</button>
            <button class="ref-btn" style="grid-column: span 2; border:1px solid var(--red); color:var(--red);" onclick="if(confirm('ç¢ºå®šé‡ç½®æ¯”è³½ï¼Ÿ')) handleInput('resetAll')">é‡ç½®æ¯”è³½ (RESET)</button>
        </div>
    </div>

    <div id="config-panel">
        <h2 style="margin-bottom:30px; color:var(--yellow); text-align:center;">è³½åˆ¶è¨­å®š</h2>
        <div class="config-item"><label>æ“Šçƒç§’æ•¸ (Shot)</label><input type="number" id="cfg-shot" value="30"></div>
        <div class="config-item"><label>è¡çƒç§’æ•¸ (Open)</label><input type="number" id="cfg-open" value="60"></div>
        <div class="config-item"><label>æš«åœåˆ†é˜ (Timeout)</label><input type="number" id="cfg-to" value="5"></div>
        <div class="config-item"><label>æ¶å±€æ•¸ (Race To)</label><input type="number" id="cfg-race" value="5"></div>
        <button class="ref-btn" style="width:100%; height:60px; background:var(--blue); margin-top:20px;" onclick="saveConfig()">å„²å­˜è¨­å®š</button>
        <button class="ref-btn" style="width:100%; height:50px; margin-top:15px; border:none; background:transparent;" onclick="document.getElementById('config-panel').style.display='none'">å–æ¶ˆ</button>
    </div>
    <div id="qr-overlay" onclick="this.style.display='none'"><div id="qrcode" style="padding:15px; background:#fff; border-radius:10px;"></div></div>

    <script>
        let peer = null, mqttClient = null, audioCtx = null;
        const myId = 'Table-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        let settings = { shot: 30, open: 60, timeout: 5, race: 5 };
        let timeLeft = 0, timerId = null, scores = {A:0, B:0}, isPaused = false, isTimeoutMode = false;
        
        function applySettings() { document.getElementById('race-display').innerText = settings.race; }

        function resetMatchState() {
            scores = {A:0, B:0};
            document.getElementById('scoreA').innerText = "0";
            document.getElementById('scoreB').innerText = "0";
            
            // ç§»é™¤è½ç‰Œæ¨£å¼
            document.getElementById('scoreA').classList.remove('score-match-point');
            document.getElementById('scoreB').classList.remove('score-match-point');

            if (timerId) clearInterval(timerId);
            timeLeft = 0; isPaused = false; isTimeoutMode = false;
            
            // éš±è—æ¨™è¨˜ & è§£é–æŒ‰éˆ•
            ['a','b'].forEach(s => {
                document.getElementById('tag-ext-'+s).style.display = 'none';
                document.getElementById('tag-to-'+s).style.display = 'none';
                if(document.getElementById('ref-ext'+s.toUpperCase())) {
                    document.getElementById('ref-ext'+s.toUpperCase()).disabled = false;
                    document.getElementById('ref-to'+s.toUpperCase()).disabled = false;
                }
            });

            document.getElementById('winner-overlay').style.display = 'none';
            document.getElementById('big-timer-layer').style.display = 'none';
            updateDisplay();
        }

        function processCommand(cmd) {
            if (cmd.startsWith('sync_cfg:')) {
                const parts = cmd.split(':')[1].split(',').map(Number);
                settings = { shot: parts[0], open: parts[1], timeout: parts[2], race: parts[3] };
                applySettings();
            }
            else if (cmd === 'start_shot') { isTimeoutMode = false; startTimer(settings.shot, 'æ“Šçƒè¨ˆæ™‚'); }
            else if (cmd === 'start_open') { isTimeoutMode = false; startTimer(settings.open, 'è¡çƒè¨ˆæ™‚'); }
            else if (cmd === 'pause') isPaused = !isPaused;
            else if (cmd.startsWith('score')) { updateScore(cmd.includes('scoreA') ? 'A' : 'B', cmd.includes('+') ? 1 : -1); }
            else if (cmd === 'extA' || cmd === 'extB') {
                const side = cmd.slice(-1); 
                document.getElementById(`tag-ext-${side.toLowerCase()}`).style.display = 'block';
                const btn = document.getElementById('ref-ext'+side);
                if(btn) btn.disabled = true; // é–å®š
                
                speak("Extension", 0.85);
                if(!isTimeoutMode) timeLeft += settings.shot;
                updateDisplay();
            }
            else if (cmd === 'toA') toggleTO('A');
            else if (cmd === 'toB') toggleTO('B');
            else if (cmd === 'resetAll') resetMatchState();
        }

        function toggleTO(side) {
            if (isTimeoutMode) {
                isTimeoutMode = false;
                startTimer(settings.shot, 'æ“Šçƒè¨ˆæ™‚');
            } else {
                isTimeoutMode = true;
                document.getElementById(`tag-to-${side.toLowerCase()}`).style.display = 'block';
                const btn = document.getElementById('ref-to'+side);
                if(btn) btn.disabled = true; // é–å®š
                startTimer(settings.timeout * 60, 'æš«åœå€’æ•¸');
            }
        }

        function startTimer(sec, labelText) {
            if (timerId) clearInterval(timerId);
            timeLeft = sec; isPaused = false;
            document.getElementById('big-timer-layer').style.display = 'block';
            document.getElementById('big-timer-label').innerText = labelText;
            updateDisplay();
            
            timerId = setInterval(() => {
                if (!isPaused && timeLeft > 0) {
                    timeLeft--;
                    if (!isTimeoutMode && timeLeft === 10) { playBeep(880, 0.1); speak("Ten seconds", 0.75); }
                    if (!isTimeoutMode && timeLeft <= 5 && timeLeft > 0) { speak(timeLeft, 0.65); }
                    updateDisplay();
                    if (timeLeft === 0) { 
                        playBeep(440, 0.8); 
                        if(isTimeoutMode) { isTimeoutMode = false; startTimer(settings.shot, 'æ“Šçƒè¨ˆæ™‚'); }
                    }
                }
            }, 1000);
        }

        function updateDisplay() {
            const bigVal = document.getElementById('big-timer-val');
            const timerLayer = document.getElementById('big-timer-layer');
            
            if (isTimeoutMode) {
                timerLayer.classList.add('timeout-mode');
                bigVal.className = "big-timer-val timer-red-text";
                let mins = Math.floor(timeLeft / 60), secs = timeLeft % 60;
                bigVal.innerText = `${mins}:${secs < 10 ? '0' + secs : secs}`;
            } else {
                timerLayer.classList.remove('timeout-mode');
                bigVal.innerText = timeLeft;
                if (timeLeft <= 5 && timeLeft > 0) bigVal.className = "big-timer-val timer-red-neon";
                else bigVal.className = "big-timer-val timer-green";
                if (timeLeft === 0) bigVal.className = "big-timer-val timer-red-neon";
            }
        }

        function updateScore(t, v) {
            // æ›´æ–°åˆ†æ•¸
            scores[t] = Math.max(0, scores[t] + v);
            const scoreEl = document.getElementById('score' + t);
            scoreEl.innerText = scores[t];
            
            // æª¢æŸ¥è½ç‰Œ (Score == Race - 1)
            // å¦‚æœç•¶å‰åˆ†æ•¸æ˜¯ç›®æ¨™å±€æ•¸æ¸›1ï¼Œé¡¯ç¤ºé»ƒè‰²éœ“è™¹
            if (scores[t] === settings.race - 1) {
                scoreEl.classList.add('score-match-point');
            } else {
                scoreEl.classList.remove('score-match-point');
            }

            // æª¢æŸ¥ç²å‹
            if (scores[t] >= settings.race) {
                document.getElementById('winner-name').innerText = `PLAYER ${t} WINS`;
                document.getElementById('winner-overlay').style.display = 'flex';
                speak(`Player ${t} wins`, 0.8);
            }
            
            // é‡ç½® EXT æ¨™è¨˜èˆ‡æŒ‰éˆ•
            document.getElementById('tag-ext-a').style.display = 'none';
            document.getElementById('tag-ext-b').style.display = 'none';
            if(document.getElementById('ref-extA')) {
                document.getElementById('ref-extA').disabled = false;
                document.getElementById('ref-extB').disabled = false;
            }
            
            if (timerId) clearInterval(timerId);
            timeLeft = 0; 
            document.getElementById('big-timer-layer').style.display = 'none';
        }

        function saveConfig() {
            settings.shot = parseInt(document.getElementById('cfg-shot').value);
            settings.open = parseInt(document.getElementById('cfg-open').value);
            settings.timeout = parseInt(document.getElementById('cfg-to').value);
            settings.race = parseInt(document.getElementById('cfg-race').value);
            const cmd = `sync_cfg:${settings.shot},${settings.open},${settings.timeout},${settings.race}`;
            if (peer && peer.connected) peer.send(cmd);
            applySettings();
            document.getElementById('config-panel').style.display = 'none';
        }

        function openConfig() {
            document.getElementById('cfg-shot').value = settings.shot;
            document.getElementById('cfg-open').value = settings.open;
            document.getElementById('cfg-to').value = settings.timeout;
            document.getElementById('cfg-race').value = settings.race;
            document.getElementById('config-panel').style.display = 'block';
        }

        function speak(text, rate) { if (window.speechSynthesis) { const m = new SpeechSynthesisUtterance(text); m.lang = 'en-US'; m.rate = rate || 1; window.speechSynthesis.speak(m); } }
        function playBeep(f, d) { if (!audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.frequency.value = f; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d); }
        function unlockAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function showQRCode() { const q = document.getElementById('qrcode'); q.innerHTML = ""; const url = window.location.origin + window.location.pathname + "?mode=ref&join=" + myId; new QRCode(q, { text: url, width: 200, height: 200 }); document.getElementById('qr-overlay').style.display = 'flex'; }
        
        function initSignaling() { 
            mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt'); 
            mqttClient.on('connect', () => { 
                document.getElementById('display-my-id').innerText = myId; 
                mqttClient.subscribe(`pool/signal/${myId}`); 
                const p = new URLSearchParams(window.location.search);
                if (p.get('mode') === 'ref') { 
                    document.getElementById('player-panel').style.display = 'none'; 
                    document.getElementById('referee-panel').style.display = 'block'; 
                } 
                if (p.get('join')) initPeer(true, p.get('join')); 
            }); 
            mqttClient.on('message', (t, m) => { const d = JSON.parse(m.toString()); if (!peer) initPeer(false, d.from); peer.signal(d.signal); }); 
        }
        function initPeer(initiator, targetId) { 
            peer = new SimplePeer({ initiator, trickle: true }); 
            peer.on('signal', d => mqttClient.publish(`pool/signal/${targetId}`, JSON.stringify({ from: myId, signal: d }))); 
            peer.on('connect', () => { 
                document.getElementById('qr-overlay').style.display='none'; 
                if(initiator) peer.send(`sync_cfg:${settings.shot},${settings.open},${settings.timeout},${settings.race}`); 
            }); 
            peer.on('data', d => processCommand(d.toString())); 
        }
        function handleInput(cmd) { unlockAudio(); if (peer && peer.connected) peer.send(cmd); processCommand(cmd); }
        window.onload = initSignaling;
    </script>
</body>
</html>
