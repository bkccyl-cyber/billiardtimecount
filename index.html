<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>專業賽事系統 - 終極特效整合版</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #000; --green: #00ff00; --red: #ff3b30; --blue: #007aff; --btn: #2a2a2a; --yellow: #ffcc00; --orange: #ff9500; --purple: #af52de; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.5s; }
        
        /* 連線資訊列 */
        .peer-info { height: 45px; background: #1a1a1a; padding: 0 15px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .offline { background: var(--red); }

        /* 分數區域 */
        .score-row { display: flex; height: 32%; border-bottom: 2px solid #333; flex-shrink: 0; }
        .team { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .team-a { background: var(--red); }
        .team-b { background: var(--blue); }
        .team-name { font-size: 1.5rem; font-weight: bold; margin-bottom: -5px; }
        .score-val { font-size: 14vh; font-weight: bold; line-height: 1; }

        /* 標籤樣式 (EXT, T.O.) */
        .tag-container { position: absolute; bottom: 8px; display: flex; gap: 5px; }
        .ext-tag, .to-tag { padding: 2px 12px; font-weight: 900; border-radius: 4px; display: none; font-size: 1rem; }
        .ext-tag { background: var(--yellow); color: #000; animation: flash 1s infinite; }
        .to-tag { background: var(--purple); color: #fff; }

        /* 計時器區域 */
        .timer-zone { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .race-to-display { font-size: 1.2rem; color: var(--yellow); font-weight: bold; margin-bottom: 10px; letter-spacing: 2px; }
        #timer-display { font-size: 32vh; font-weight: bold; color: var(--green); line-height: 0.8; transition: all 0.3s; }
        
        .timeout-active { color: var(--purple) !important; }
        .warning { color: var(--red) !important; animation: blink 0.5s infinite alternate; }
        .status-text { font-size: 14px; color: #666; letter-spacing: 5px; position: absolute; top: 10%; font-weight: bold; }

        /* 控制按鈕區域 */
        .controls { height: 35%; display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 8px; background: #111; }
        .btn { border: none; border-radius: 10px; color: #fff; background: var(--btn); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); background: #444; }
        .btn-k { font-size: 1.1rem; font-weight: bold; }
        .btn-sub { font-size: 0.9rem; opacity: 0.8; }

        /* 勝利特效樣式 */
        .victory-a { background: var(--red) !important; animation: win-flash 0.5s infinite alternate; }
        .victory-b { background: var(--blue) !important; animation: win-flash 0.5s infinite alternate; }
        .winner-text { font-size: 15vh !important; color: white !important; }

        /* 隱藏按鈕模式 (觀眾/選手螢幕用) */
        .hidden-mode .controls { display: none; }
        .hidden-mode .score-row { height: 40%; }
        .hidden-mode #timer-display { font-size: 45vh; }
        .hidden-mode .race-to-display { font-size: 2rem; }

        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }
        @keyframes win-flash { from { filter: brightness(1); } to { filter: brightness(1.8); } }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="peer-info">
        <div><span id="conn-dot" class="status-dot offline"></span> ID: <span id="peer-id-display">取得中...</span></div>
        <div style="display:flex; gap:8px;">
            <button onclick="toggleDisplayMode()" id="mode-btn" style="padding:4px 12px; background:var(--yellow); border:none; border-radius:4px; font-weight:bold; color:black;">隱藏控制</button>
            <button onclick="connectToPeer()" style="padding:4px 12px; background:var(--blue); color:white; border:none; border-radius:4px;">連接遠端</button>
        </div>
    </div>

    <div class="score-row">
        <div class="team team-a" onclick="handleInput('scoreA+')">
            <div class="team-name" id="nameA">PLAYER A</div>
            <div class="score-val" id="scoreA">0</div>
            <div class="tag-container"><div id="extA" class="ext-tag">EXT</div><div id="toA" class="to-tag">T.O.</div></div>
        </div>
        <div class="team team-b" onclick="handleInput('scoreB+')">
            <div class="team-name" id="nameB">PLAYER B</div>
            <div class="score-val" id="scoreB">0</div>
            <div class="tag-container"><div id="extB" class="ext-tag">EXT</div><div id="toB" class="to-tag">T.O.</div></div>
        </div>
    </div>

    <div class="timer-zone">
        <div class="status-text" id="status-text">點擊螢幕解鎖音效</div>
        <div class="race-to-display" id="race-to-text">RACE TO --</div>
        <div id="timer-display">00</div>
    </div>

    <div class="controls">
        <button class="btn" style="color:var(--green);" onclick="handleInput('start_30')"><div class="btn-k">Start</div><div class="btn-sub" id="btn-text-start">30s</div></button>
        <button class="btn" onclick="handleInput('start_60')"><div class="btn-k">Open Time</div><div class="btn-sub" id="btn-text-open">60s</div></button>
        <button class="btn" onclick="handleInput('pause')"><div class="btn-k">Pause</div>暫停/繼續</button>
        <button class="btn" style="color:var(--red); border:1.5px solid var(--red);" onclick="handleInput('resetAll')"><div class="btn-k">Reset All</div>歸零</button>
        
        <button class="btn" style="color:var(--purple); border:1.5px solid var(--purple);" onclick="handleInput('toA')"><div class="btn-k">T.O. A</div>5 min</button>
        <button class="btn" onclick="handleInput('scoreA-')"><div class="btn-k">A 扣分</div></button>
        <button class="btn" onclick="handleInput('scoreB-')"><div class="btn-k">B 扣分</div></button>
        <button class="btn" style="color:var(--purple); border:1.5px solid var(--purple);" onclick="handleInput('toB')"><div class="btn-k">T.O. B</div>5 min</button>
        
        <button class="btn" style="color:var(--yellow); border:1px solid var(--yellow);" onclick="handleInput('extA')"><div class="btn-k">A 延長</div><div class="btn-sub" id="btn-text-extA">+30s</div></button>
        <button class="btn" onclick="changeNames()"><div class="btn-k">Name</div>修改隊名</button>
        <button class="btn" onclick="setupTimes()"><div class="btn-k">⚙️設定</div>Race/秒數</button>
        <button class="btn" style="color:var(--yellow); border:1px solid var(--yellow);" onclick="handleInput('extB')"><div class="btn-k">B 延長</div><div class="btn-sub" id="btn-text-extB">+30s</div></button>
    </div>

    <script>
        // 變數初始化
        let timeLeft = 0, timerId = null, scores = { A: 0, B: 0 }, config = { key0: 30, key2: 60, raceTo: 0 };
        let isPaused = false, isTimeoutMode = false, lastNormalTime = 0, isGameOver = false;
        let peer = null, conn = null, audioCtx = null;

        // 音效系統
        function unlockAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const b = audioCtx.createBuffer(1, 1, 22050), s = audioCtx.createBufferSource();
                s.buffer = b; s.connect(audioCtx.destination); s.start();
                document.getElementById('status-text').innerText = "系統已就緒";
            }
        }

        function playBeep(f, d) {
            try {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.frequency.setValueAtTime(f, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
                o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
            } catch(e) {}
        }

        // PeerJS 遠端連線邏輯
        function initPeer() {
            const rid = Math.floor(1000 + Math.random() * 9000).toString();
            peer = new Peer(rid);
            peer.on('open', (id) => { 
                document.getElementById('peer-id-display').innerText = id; 
                document.getElementById('conn-dot').className = "status-dot online"; 
            });
            peer.on('connection', (c) => { 
                conn = c; 
                conn.on('data', (d) => processCommand(d)); 
                conn.on('open', () => document.getElementById('conn-dot').style.boxShadow = "0 0 15px var(--blue)");
            });
            peer.on('error', () => setTimeout(initPeer, 3000));
        }

        function handleInput(cmd) { if (conn && conn.open) conn.send(cmd); processCommand(cmd); }

        // 核心指令處理
        function processCommand(cmd) {
            unlockAudio();
            if (isGameOver && cmd !== 'resetAll') return; // 獲勝後鎖定按鈕

            if (cmd === 'start_30') { stopTimeout(); startTimer(config.key0); }
            else if (cmd === 'start_60') { stopTimeout(); startTimer(config.key2); }
            else if (cmd === 'pause') togglePause();
            else if (cmd === 'resetAll') resetEverything();
            else if (cmd === 'scoreA+') { updateScore('A', 1); clearExt(); checkWinner(); }
            else if (cmd === 'scoreB+') { updateScore('B', 1); clearExt(); checkWinner(); }
            else if (cmd === 'scoreA-') updateScore('A', -1);
            else if (cmd === 'scoreB-') updateScore('B', -1);
            else if (cmd === 'extA') { showExt('A'); addTime(config.key0); }
            else if (cmd === 'extB') { showExt('B'); addTime(config.key0); }
            else if (cmd === 'toA') toggleTimeout('A');
            else if (cmd === 'toB') toggleTimeout('B');
            else if (cmd.startsWith('names:')) {
                const n = JSON.parse(cmd.split('names:')[1]);
                document.getElementById('nameA').innerText = n.a; 
                document.getElementById('nameB').innerText = n.b;
            }
            else if (cmd.startsWith('config:')) {
                config = JSON.parse(cmd.split('config:')[1]);
                updateButtonLabels(); updateRaceToUI();
            }
        }

        // 計時器邏輯
        function startTimer(sec) {
            if (timerId) clearInterval(timerId);
            timeLeft = Number(sec); isPaused = false; 
            updateDisplay();
            if (timeLeft <= 0) return;
            document.getElementById('status-text').innerText = isTimeoutMode ? "TIME OUT" : "COUNTING";
            timerId = setInterval(() => {
                if (!isPaused) {
                    timeLeft--; updateDisplay(); 
                    if (timeLeft === 10) playBeep(880, 0.1);
                    else if (timeLeft <= 5 && timeLeft > 0) playBeep(1200, 0.1);
                    
                    if (timeLeft <= 0) { 
                        clearInterval(timerId); timerId = null; 
                        document.getElementById('status-text').innerText = "TIME UP"; 
                        playBeep(440, 1.0); 
                    }
                }
            }, 1000);
        }

        function updateDisplay() {
            const d = document.getElementById('timer-display');
            if (isGameOver) return;
            let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            d.innerText = isTimeoutMode ? `${m}:${s < 10 ? '0'+s : s}` : (timeLeft < 10 ? "0"+timeLeft : timeLeft);
            d.className = (isTimeoutMode ? "timeout-active " : "") + (timeLeft <= 5 && timeLeft > 0 && !isPaused ? "warning" : "");
        }

        // 勝負與特效邏輯
        function checkWinner() {
            if (config.raceTo > 0) {
                if (scores.A >= config.raceTo) showVictory('A');
                else if (scores.B >= config.raceTo) showVictory('B');
            }
        }

        function showVictory(winner) {
            isGameOver = true;
            if (timerId) clearInterval(timerId);
            const name = document.getElementById('name' + winner).innerText;
            document.body.className = winner === 'A' ? 'victory-a' : 'victory-b';
            document.getElementById('timer-display').innerText = "WINNER";
            document.getElementById('timer-display').classList.add('winner-text');
            document.getElementById('status-text').innerText = name + " 獲勝！";
            // 勝利音效
            playBeep(600, 0.2); setTimeout(() => playBeep(800, 0.2), 200); setTimeout(() => playBeep(1000, 0.5), 400);
        }

        // 各種功能控制
        function togglePause() { 
            if (timerId || timeLeft > 0) { 
                isPaused = !isPaused; 
                document.getElementById('status-text').innerText = isPaused ? "PAUSED" : "COUNTING"; 
            } 
        }

        function toggleTimeout(t) { 
            if (isTimeoutMode) { stopTimeout(); return; } 
            lastNormalTime = timeLeft; isTimeoutMode = true; 
            document.getElementById('to'+t).style.display = 'block'; // 保留標籤直到 Reset
            startTimer(300); 
        }

        function stopTimeout() { if (!isTimeoutMode) return; isTimeoutMode = false; startTimer(lastNormalTime); }

        function resetEverything() {
            if (timerId) clearInterval(timerId);
            timerId = null; scores = {A:0, B:0}; isGameOver = false;
            updateScore('A', 0); updateScore('B', 0);
            document.getElementById('toA').style.display='none'; 
            document.getElementById('toB').style.display='none';
            clearExt(); isTimeoutMode = false; timeLeft = 0; 
            document.body.className = ""; 
            document.getElementById('timer-display').classList.remove('winner-text');
            updateDisplay(); updateRaceToUI();
            document.getElementById('status-text').innerText = "READY";
        }

        function updateScore(t, v) { 
            scores[t] = Math.max(0, scores[t] + v); 
            document.getElementById(`score${t}`).innerText = scores[t]; 
        }

        function showExt(t) { document.getElementById('ext'+t).style.display='block'; }
        function clearExt() { document.getElementById('extA').style.display='none'; document.getElementById('extB').style.display='none'; }
        function addTime(s) { timeLeft += s; updateDisplay(); if (!timerId) startTimer(timeLeft); }

        function updateButtonLabels() {
            document.getElementById('btn-text-start').innerText = config.key0 + "s";
            document.getElementById('btn-text-open').innerText = config.key2 + "s";
            document.getElementById('btn-text-extA').innerText = "+" + config.key0 + "s";
            document.getElementById('btn-text-extB').innerText = "+" + config.key0 + "s";
        }

        function updateRaceToUI() { 
            document.getElementById('race-to-text').innerText = config.raceTo > 0 ? `RACE TO ${config.raceTo}` : "RACE TO --"; 
        }

        // 設定選單
        function setupTimes() {
            const s1 = Number(prompt("設定 Start 秒數：", config.key0)) || 30;
            const s2 = Number(prompt("設定 Open Time 秒數：", config.key2)) || 60;
            const r = Number(prompt("設定搶局數 (Race To)：", config.raceTo)) || 0;
            config.key0 = s1; config.key2 = s2; config.raceTo = r;
            updateButtonLabels(); updateRaceToUI();
            if (conn && conn.open) conn.send("config:" + JSON.stringify(config));
        }

        function changeNames() {
            const na = prompt("A 隊名：", document.getElementById('nameA').innerText);
            const nb = prompt("B 隊名：", document.getElementById('nameB').innerText);
            handleInput("names:"+JSON.stringify({a:na||"PLAYER A", b:nb||"PLAYER B"}));
        }

        function toggleDisplayMode() {
            document.body.classList.toggle('hidden-mode');
            document.getElementById('mode-btn').innerText = document.body.classList.contains('hidden-mode') ? "顯示控制" : "隱藏控制";
        }

        function connectToPeer() { const rid = prompt("輸入對手 ID："); if(rid) conn = peer.connect(rid); }

        window.onload = () => { initPeer(); updateButtonLabels(); updateRaceToUI(); };
    </script>
</body>
</html>